import { useState, useEffect } from "react";
import { useMainStore } from "../lib/store/store";
import { Input } from "../components/UI/Input";
import { Button } from "../components/UI/Button";
import { logOut, updateProfile } from "../lib/auth";
import { Navbar } from "../components/Navbar";
import { User } from "firebase/auth";
import { getAuth, updateEmail, updateProfile as firebaseUpdateProfile } from "firebase/auth";

export const ProfilePage = () => {
    const auth = getAuth();
    const user = useMainStore(state => state.user) as User;
    const [name, setName] = useState(user.displayName || '');
    const [email, setEmail] = useState(user.email || '');
    const [isDisabled, setIsDisabled] = useState(false);

    useEffect(() => {
        // Check if the user logged in using Google
        setIsDisabled(user.providerData.some(p => p.providerId === 'google.com'));
    }, [user.providerData]);

    const handleUpdate = async () => {
        if (!name || !email) {
            alert("Name and email cannot be empty.");
            return;
        }
        try {
            // Update profile in Firebase Authentication
            await firebaseUpdateProfile(user, { displayName: name });
            await updateEmail(user, email);
            // Optional: Update the user's profile in your Firebase Realtime Database
            await updateProfile(user.uid, { name, email });
            alert("Profile updated successfully!");
        } catch (error) {
            console.error("Error updating profile:", error);
            alert(error.message);
        }
    };

    return (
        <div className="flex flex-col gap-4">
            <p className="text-primaryText text-center text-2xl">Profile Information</p>
            <form className="flex flex-col gap-4" onSubmit={(e) => { e.preventDefault(); handleUpdate(); }}>
                <Input
                    value={name}
                    onChange={e => setName(e.target.value)}
                    label="Name"
                    type="text"
                    placeholder="Name and Surname"
                    disabled={isDisabled}
                />
                <Input
                    value={email}
                    onChange={e => setEmail(e.target.value)}
                    label="Email"
                    type="email"
                    placeholder="example@gmail.com"
                    disabled={isDisabled}
                />
                <Button variant="primary" type="submit" disabled={isDisabled}>Save</Button>
                <Button variant="outlined" onClick={logOut}>Log out</Button>
            </form>
            <Navbar />
        </div>
    );
};